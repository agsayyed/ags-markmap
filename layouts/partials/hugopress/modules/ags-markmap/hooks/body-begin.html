{{- /* AGS Markmap Hook: Load scripts and initialize markmap when enabled in front matter */ -}} {{-
if .Page.Params.ags_markmap -}} {{- /* Use UNPKG with a known working version
*/ -}}
<script src="https://unpkg.com/d3@7/dist/d3.min.js"></script>
<script src="https://unpkg.com/markmap-view@0.15.8/dist/browser/index.js"></script>

{{- /* Pass options to JavaScript and initialize markmap */ -}} {{- $opts :=
.Page.Params.ags_markmap_opts | default dict | jsonify -}}
<script>
  console.log('[ags-markmap] Starting initialization...');
  window.agsMarkmapOptions = {{ $opts | safeJS }};
  console.log("[ags-markmap] Options loaded:", window.agsMarkmapOptions);

  document.addEventListener('DOMContentLoaded', function() {
    console.log('[ags-markmap] DOM ready');

    // Function to check if markmap is loaded
    function checkMarkmapLoaded() {
      return new Promise((resolve, reject) => {
        let attempts = 0;
        const maxAttempts = 20; // 10 seconds total
        
        const checkInterval = setInterval(() => {
          attempts++;
          console.log(`[ags-markmap] Loading attempt ${attempts}/${maxAttempts}`);
          
          // Check for different possible global objects
          const hasD3 = typeof window.d3 !== 'undefined';
          const hasMarkmap = typeof window.markmap !== 'undefined' && window.markmap.Markmap;
          const hasGlobalMarkmap = typeof window.Markmap !== 'undefined';
          const hasMarkmapView = typeof window.markmapView !== 'undefined';
          
          console.log('[ags-markmap] Load status:', { hasD3, hasMarkmap, hasGlobalMarkmap, hasMarkmapView });
          console.log('[ags-markmap] window.markmap:', typeof window.markmap);
          console.log('[ags-markmap] window.markmapView:', typeof window.markmapView);
          console.log('[ags-markmap] Available globals:', Object.keys(window).filter(k => k.toLowerCase().includes('mark')));
          
          if (hasD3 && (hasMarkmap || hasGlobalMarkmap || hasMarkmapView)) {
            clearInterval(checkInterval);
            resolve(true);
          } else if (attempts >= maxAttempts) {
            clearInterval(checkInterval);
            reject(new Error(`Libraries not loaded after ${maxAttempts} attempts. D3: ${hasD3}, Markmap: ${hasMarkmap || hasGlobalMarkmap || hasMarkmapView}`));
          }
        }, 500);
      });
    }

    // Start checking for markmap libraries
    checkMarkmapLoaded()
      .then(() => {
        console.log('[ags-markmap] Libraries loaded successfully!');
        initializeMarkmap();
      })
      .catch((error) => {
        console.error('[ags-markmap] Failed to load libraries:', error);
        showError('Libraries failed to load: ' + error.message);
      });

    function showError(message) {
      const container = document.getElementById('ags-markmap-container');
      if (container) {
        container.innerHTML = `<div style="color: orange; padding: 20px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;">
          <strong>‚ö†Ô∏è Warning:</strong> ${message}<br>
          <small>Check network connectivity and CDN availability</small>
        </div>`;
      }
    }

    function initializeMarkmap() {
      console.log('[ags-markmap] Starting markmap initialization...');
      console.log('[ags-markmap] window.markmap:', typeof window.markmap);
      console.log('[ags-markmap] window.markmap?.Markmap:', typeof window.markmap?.Markmap);
      console.log('[ags-markmap] Available globals:', Object.keys(window).filter(k => k.toLowerCase().includes('mark')));

      const container = document.getElementById('ags-markmap-container');
      if (!container) {
        console.warn('[ags-markmap] No container found');
        return;
      }

      // Show loading state first
      container.innerHTML = '<div style="padding: 20px; border: 2px solid #ffc107; background: #fff3cd; color: #856404;">üîÑ Initializing markmap...</div>';

      // Check if markmap is available in any form
      const markmapAPI = window.markmap?.Markmap || window.Markmap || window.markmapView?.Markmap;
      
      if (markmapAPI) {
        console.log('[ags-markmap] Markmap found!', markmapAPI);

        try {
          // Extract headings dynamically from the current page
          function extractHeadings() {
            const headings = Array.from(document.querySelectorAll('h1, h2, h3, h4, h5, h6'))
              .filter(h => {
                // Filter out navigation and system headings
                const parent = h.closest('.hb-docs-sidebar, .hb-docs-toc, nav, .navbar, .breadcrumb');
                return !parent && h.textContent.trim().length > 0;
              })
              .map(h => {
                // Get clean text content, removing anchor symbols and other decorations
                let text = h.textContent || h.innerText || '';
                
                // Remove common anchor link symbols and decorations
                text = text.replace(/[¬ß¬∂#‚Üµ‚åò‚àû‚Ä†‚Ä°‚òÖ‚òÜ‚ô¶‚ô†‚ô£‚ô•‚Üê‚Üí‚Üë‚Üì]/g, ''); // Various symbols
                text = text.replace(/[\u00A0-\u00FF\u2000-\u206F\u2E00-\u2E7F]/g, ' '); // Unicode symbols and spaces
                text = text.replace(/\s+/g, ' '); // Normalize whitespace
                text = text.trim();
                
                return {
                  level: parseInt(h.tagName.charAt(1)),
                  text: text,
                  element: h
                };
              })
              .filter(h => h.text.length > 0); // Remove empty headings after cleaning

            console.log('[ags-markmap] Found headings:', headings);
            return headings;
          }

          // Build tree structure from flat heading list
          function buildTree(headings) {
            if (headings.length === 0) {
              return {
                content: 'No headings found',
                children: []
              };
            }

            // Extract clean page title (remove site branding)
            const fullTitle = document.title || 'Page Content';
            const cleanTitle = fullTitle.split(' - ')[0] || fullTitle.split(' | ')[0] || fullTitle;
            
            // Filter out the first heading if it matches the page title (to avoid duplication)
            const filteredHeadings = headings.filter((heading, index) => {
              if (index === 0 && heading.text.toLowerCase().trim() === cleanTitle.toLowerCase().trim()) {
                return false; // Skip first heading if it matches page title
              }
              return true;
            });
            
            // Create simple root node (compatible with older markmap)
            const root = {
              content: cleanTitle,
              children: []
            };

            const stack = [{ node: root, level: 0 }];

            filteredHeadings.forEach(heading => {
              const newNode = {
                content: heading.text,
                children: []
              };

              // Find the right parent level
              while (stack.length > 1 && stack[stack.length - 1].level >= heading.level) {
                stack.pop();
              }

              // Add to parent
              stack[stack.length - 1].node.children.push(newNode);
              stack.push({ node: newNode, level: heading.level });
            });

            return root;
          }

          // Extract headings and build tree
          const headings = extractHeadings();
          const root = buildTree(headings);

          console.log('[ags-markmap] Built dynamic tree:', root);

          // Clear container and let CSS handle styling
          container.innerHTML = '';

          // Create SVG element with proper constraints
          const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
          container.appendChild(svg);

          console.log('[ags-markmap] SVG created, initializing markmap...');
          console.log('[ags-markmap] Available markmap methods:', Object.keys(window.markmap));

          // Create markmap with basic options
          const options = {
            autoFit: true,
            zoom: true,
            pan: true,
            ...window.agsMarkmapOptions
          };

          console.log('[ags-markmap] Creating markmap with options:', options);

          // Use the detected markmap API
          let mm;
          
          if (typeof markmapAPI.create === 'function') {
            // Try the create static method
            mm = markmapAPI.create(svg, options, root);
            console.log('[ags-markmap] Created with static create method');
          } else {
            // Try constructor approach
            mm = new markmapAPI(svg, options);
            if (mm && typeof mm.setData === 'function') {
              mm.setData(root);
              console.log('[ags-markmap] Created with constructor + setData');
            } else {
              console.log('[ags-markmap] Created with constructor only');
            }
          }

          console.log('[ags-markmap] Markmap created successfully!', mm);

          // Add a subtle success indicator that doesn't interfere with layout
          const successDiv = document.createElement('div');
          successDiv.style.cssText = 'position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: rgba(212, 237, 218, 0.9); color: #155724; border: 1px solid #c3e6cb; border-radius: 4px; font-size: 12px; font-weight: bold; z-index: 10;';
          successDiv.textContent = '‚úÖ Interactive mindmap - zoom & pan enabled';
          container.style.position = 'relative';
          container.appendChild(successDiv);

          // Verify rendering after a short delay
          setTimeout(() => {
            if (svg.children.length > 0) {
              console.log('[ags-markmap] SVG rendered with', svg.children.length, 'child elements');
            } else {
              console.warn('[ags-markmap] SVG appears empty after rendering');
              // Add fallback visualization
              svg.innerHTML = `
                <g transform="translate(400,250)">
                  <circle r="40" fill="#4285f4" stroke="#1a73e8" stroke-width="2"/>
                  <text y="6" text-anchor="middle" fill="white" font-family="Arial" font-size="12">Markmap</text>
                  <text y="-60" text-anchor="middle" fill="#1a73e8" font-family="Arial" font-size="14">‚úì AGS Markmap Active</text>
                </g>
              `;
            }

            // Fit the view
            if (mm && mm.fit) {
              mm.fit();
              console.log('[ags-markmap] View fitted');
            }
          }, 200);

        } catch (error) {
          console.error('[ags-markmap] Error creating markmap:', error);
          console.error('[ags-markmap] Error stack:', error.stack);
          
          container.innerHTML = `<div style="color: red; padding: 20px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px;">
            <strong>‚ùå Error:</strong> ${error.message}<br>
            <small>Check browser console for details</small><br>
            <details style="margin-top: 10px;">
              <summary>Debug Info</summary>
              <pre style="font-size: 11px; margin: 5px 0;">${JSON.stringify({
                markmapType: typeof window.markmap,
                markmapKeys: window.markmap ? Object.keys(window.markmap) : 'undefined',
                markmapCreateType: typeof window.markmap?.Markmap?.create
              }, null, 2)}</pre>
            </details>
          </div>`;
        }
      } else {
        console.warn('[ags-markmap] Markmap libraries not found');
        showError('Markmap libraries not loaded');
      }
    }
  });
</script>

{{- else -}}
<script>
  console.log('[ags-markmap] Module disabled on this page')
</script>
{{- end -}}
